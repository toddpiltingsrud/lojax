var lojax=lojax||{};(function(n,t){var u,i,r;t.on=function(t,i){n(document).on(t,function(){r.executeRequest(i)})};t.off=function(t){n(document).off(t)};t.get=function(n){r.executeRequest(n)};t.onLoad=function(n){r.onLoad=n};t.closeModal=function(){i.hasValue(r.modal)&&(n.fn.modal?r.modal.modal("hide"):n.fn.kendoWindow&&r.modal.data("kendoWindow").close())};t.bind=function(t,r){var u=n(t);return i.hasValue(r)&&r!==""?i.setElementsFromModel(u,r):r=i.buildModelFromElements(u),u.data("model",r),r};t.events={beforeRequest:"beforeRequest",afterRequest:"afterRequest",beforeUpdateModel:"beforeUpdateModel",afterUpdateModel:"afterUpdateModel",beforeInject:"beforeInject",afterInject:"afterInject",ajaxError:"ajaxError"};t.logging=!1;t.log=function(n){try{if(t.logging&&console&&console.log)return console.log(n),console}catch(i){}return{log:function(){}}};t.config={prefix:"jx-",transition:"fade-in",hash:!0};t.select={methodOrRequest:"[data-request],[jx-request],[data-method]:not([data-trigger]),[jx-method]:not([jx-trigger])",methodWithChange:"[data-method][data-trigger*=change],[jx-method][jx-trigger*=change]",methodWithEnterOrModel:"[data-method][data-trigger*=enter],[jx-method][jx-trigger*=enter],[data-model],[jx-model]",formWithMethod:"form[data-method],form[jx-method]",model:"[data-model],[jx-model]",panel:function(n){return"["+t.config.prefix+'panel="'+n+'"],[data-panel="'+n+'"]'},divWithSrc:"div[data-src],div[jx-src]",prefetch:"[data-cache=prefetch],[jx-cache=prefetch]",jxModelAttribute:"[jx-model]",jxModel:"jx-model"},function(){t.config.prefix!=="jx-"&&(Object.getOwnPropertyNames(t.select).forEach(function(n){n!=="panel"&&(t.select[n]=t.select[n].replace(/jx-/g,t.config.prefix))}),t.log(t.select))}();t.Cache=function(){this.store={}};t.Cache.prototype={add:function(n){this.remove(n.action);this.store[n.action]=n;n.expire&&this.setTimeout(n)},remove:function(n){var t=this.store[n];t&&(t.timeout&&clearTimeout(t.timeout),delete this.store[n])},get:function(n){var t=this.store[n];if(t)return t.renew==="sliding"&&t.timeout&&this.setTimeout(t),this.store[n]},setTimeout:function(n){var t=this;n.timeout&&clearTimeout(n.timeout);n.timeout=setTimeout(function(){t.expire(n)},n.expire*1e3)},expire:function(n){n.renew==="auto"?(n.exec(),this.setTimeout(n)):this.remove(n.action)},clear:function(){var n=this,t=Object.getOwnPropertyNames(this.store);t.forEach(function(t){n.remove(t)})},contains:function(n){return n in this.store}};t.Controller=function(){var r=this;this.div=null;this.modal=null;this.currentTransition=null;this.currentPanel=null;this.cache=new t.Cache;n(function(){r.div=n("<div style='display:none'><\/div>").appendTo("body");n(document).on("click",t.select.methodOrRequest,r.handleRequest);n(document).on("change",t.select.methodWithChange,r.handleRequest);n(document).on("keydown",t.select.methodWithEnterOrModel,r.handleEnterKey);n(document).on("submit",t.select.formWithMethod,r.handleRequest);n(document).on("change",t.select.model,r.updateModel);t.config.hash&&window.addEventListener("hashchange",r.handleHash,!1);r.loadDataSrcDivs();r.bindToModels();r.prefetchAsync();i.hasHash()&&setTimeout(r.handleHash,0)})};t.Controller.prototype={handleRequest:function(f){var o=i.getConfig(this),h=n(this),e,s;o.beforeRequest=r.beforeRequest;o.afterRequest=r.afterRequest;t.log("handleRequest: params: ").log(o);e=new t.Request(o);i.hasHash(e.action)&&o.method==="ajax-get"?(s=e.action.match(u.hash)[1],e.data&&(s+="?"+e.data),r.currentTransition=e.transition,"#"+s===window.location.hash?r.handleHash():window.location.hash=s):r.executeRequest(e);f.stopPropagation();f.preventDefault()},handleEnterKey:function(n){n.which===13&&r.handleRequest.call(this,n)},handleHash:function(){if(t.config.hash){var f,u=window.location.hash;t.log("handleHash: hash:").log(u);i.hasHash()?(f=n('a[name="'+u.substr(1)+'"]'),f.size()===0&&r.executeRequest({action:u,method:"ajax-get",transition:r.currentTransition,beforeRequest:r.beforeRequest,afterRequest:r.afterRequest}),r.currentTransition=null):u===""&&r.executeRequest({action:window.location.href,method:"ajax-get",beforeRequest:r.beforeRequest,afterRequest:r.afterRequest})}},executeRequest:function(n){(n instanceof t.Request||(n=new t.Request(n)),t.log("executeRequest: request: ").log(n),n.action!==null)&&(n.cache&&(this.cache.contains(n.action)?(n=this.cache.get(n.action),t.log("executeRequest: retrieved from cache")):(this.cache.add(n),t.log("executeRequest: added to cache"))),n.exec().then(function(t){r.injectContent(n,t)}).catch(r.handleError))},bindToModels:function(r){r=r||document;var u,f,e=[],o=n(r).find(t.select.model).add(r).filter(t.select.model);return t.log("bindToModels: dataModels:").log(o),o.each(function(){f=n(this);u=i.getModel(f);u=t.bind(f,u);e.push(u);t.log("bindToModels: model:").log(u)}),e},updateModel:function(r){var f=n(this),h=n(r.target),o=i.getModel(f),e=r.target.name,s,u;i.hasValue(e)&&((s=f.find('[name="'+e+'"]'),u={target:r.target,name:e,value:h.val(),type:n.type(o[e]),model:o,cancel:!1},t.log("updateModel: o:").log(u),i.triggerEvent(t.events.beforeUpdateModel,u,f),u.cancel)||(t.log("updateModel: o.model").log(u.model),i.setModelProperty(f,u.model,s),i.triggerEvent(t.events.afterUpdateModel,u,f),t.log("updateModel: afterUpdateModel raised")))},injectContent:function(u,f){var l,a,v,y,e,s,c,o,h;if(i.hasValue(f)&&(r.onLoad=null,c=function(){var f=n(this);l=i.attr(f,"panel");a=u.target||n(t.select.panel(l)).first();a.length&&(t.log("injectContent: data-panel: "+l),y=i.resolveTransition(u,f),s=y(a,f),i.hasValue(u)&&(s.refresh=u.exec.bind(u)),i.triggerEvent(t.events.afterInject,s,f),r.bindToModels(s),i.callOnLoad(s),r.loadDataSrcDivs(s),r.prefetchAsync(s))},o=n.parseHTML(f,!0),o)){if(u.target)c.call(n(f));else for(t.log("injectContent: nodes:").log(o),h=0;h<o.length;h++){if(e=n(o[h]),i.triggerEvent(t.events.beforeInject,o,e),r.modal===null)if(e.is(".modal")){r.createModal(e);continue}else v=e.find(".modal"),v.length&&r.createModal(v);u.target||e.is(i.attrSelector("panel"))?c.call(e):n(o[h]).find(i.attrSelector("panel")).each(c)}r.div.empty();o.forEach(function(t){e=n(t);e.is("script,style")&&r.div.append(e)})}},createModal:function(t){if(n.fn.modal){r.modal=n(t).appendTo("body").modal({show:!1,keyboard:!0});r.modal.on("hidden.bs.modal",function(){i.hasValue(r.modal)&&(r.modal.off("hidden.bs.modal",r.onModalClose),r.modal.modal("hide"),n(r.modal).remove(),r.modal=null)});r.modal.modal("show")}else n.fn.kendoWindow&&(r.modal=n(t).appendTo("body").kendoWindow({title:n(t).find(".dialog-header").text(),modal:!0,animation:{open:{effects:"fade:in"}},visible:!1,close:function(){i.hasValue(r.modal)&&(r.modal.data("kendoWindow").destroy(),n(r.modal).remove(),r.modal=null)}}),r.modal.data("kendoWindow").center().open(),r.modal.find("[data-dismiss=modal]").click(function(){r.modal.data("kendoWindow").close()}));r.modal&&(r.bindToModels(r.modal),i.callOnLoad(r.modal),r.loadDataSrcDivs(r.modal),r.prefetchAsync(r.modal))},loadDataSrcDivs:function(u){u=u||document;n(u).find(t.select.divWithSrc).each(function(){var t=n(this),u=i.attr(t,"src");r.executeRequest({action:i.noCache(u),method:"ajax-get",target:t,source:t,transition:i.attr(t,"transition")||"append"})})},prefetchAsync:function(r){var f=this,e,u;r=r||document;setTimeout(function(){n(r).find(t.select.prefetch).each(function(){e=i.getConfig(this);u=new t.Request(e);u.action&&!f.cache.contains(u.action)&&(f.cache.add(u),u.exec(),t.log("prefetchAsync: request:").log(u))})})},handleError:function(n){if(i.triggerEvent(t.events.ajaxError,n),!n.handled){var r=[];Object.getOwnPropertyNames(n).forEach(function(t){typeof n[t]!="function"&&r.push(n[t])});t.log("handleError: response: ").log(n)}},beforeRequest:function(n){i.triggerEvent(t.events.beforeRequest,n,n.source)},afterRequest:function(n){i.triggerEvent(t.events.afterRequest,n,n.source)}};u={segments:/[^\[\]\.\s]+|\[\d+\]/g,indexer:/\[\d+\]/,search:/\?.+(?=#)|\?.+$/,hash:/#((.*)?[a-z]{2}(.*)?)/i,json:/^\{.*\}$|^\[.*\]$/};i={noop:function(){},hasValue:function(n){return n!==undefined&&n!==null},attr:function(i,r){return n(i).data(r)||n(i).attr(t.config.prefix+r)},attrSelector:function(n){return"[data-"+n+"],["+t.config.prefix+n+"]"},isJSON:function(n){return u.json.test(n)},attributes:"method action transition target form model cache expire renew".split(" "),getConfig:function(t){var r,u=n(t);return u.is(i.attrSelector("request"))?r=JSON.parse(i.attr(u,"request").replace(/'/g,'"')):(r={},i.attributes.forEach(function(n){var t=i.attr(u,n);t!==undefined&&(r[n]=t)})),r.source=t,r},resolveAction:function(r){if(i.hasValue(r.action)&&r.action.length)return r.action;if(i.hasValue(r.source)&&i.hasValue(r.source.href)&&r.source.href.length&&r.source.href.substr(r.source.href.length-1,1)!=="#"&&r.source.href.substr(0,11)!=="javascript:")return r.source.href;if(n(r.source).is("[type=submit]")){var u=n(r.source).closest("form,"+t.select.model);if(u.is("form"))return u.attr("action")||window.location.href}return n(r.source).is("form")?n(r.source).attr("action")||window.location.href:null},resolveForm:function(r){var u;return i.hasValue(r.form)?n(r.form).find(":input").add(n(r.form).filter(":input")):n(r.source).is("[type=submit]")&&(u=n(r.source).closest("form,"+t.select.model),u.is("form"))?u:n(r.source).is("form")?r.source:null},resolveModel:function(r){t.log("resolveModel: params:").log(r);var f,u;return i.hasValue(r.model)?u=r.model:i.hasValue(r.source)&&n(r.source).is(t.select.model)?u=i.attr(r.source,"model"):n(r.source).is("input[type=submit],button[type=submit]")&&(f=n(r.source).closest("form,"+t.select.model),f.is(t.select.model)&&(u=i.attr(f,"model"))),i.hasValue(u)&&typeof u=="string"&&(u=i.isJSON(u)?JSON.parse(u):new t.Request({action:u,method:"ajax-get"})),r.source&&u&&n(r.source).data("model",u),u},getModel:function(r){var u=i.attr(r,"model");return i.hasValue(u)&&typeof u=="string"&&(u=i.isJSON(u)?JSON.parse(u):new t.Request({action:u,method:"ajax-get"}),n(r).data("model",u)),u},resolveTarget:function(t){return i.hasValue(t.target)?n(t.target):null},resolveTransition:function(n,r){return n.transition?t.Transitions[n.transition]||t.Transitions[t.config.transition]:t.Transitions[i.attr(r,"transition")]||t.Transitions[t.config.transition]},formFromInputs:function(t,i,r){if(n(t).length){i=i||window.location.href;r=r||"POST";var u=n("<form method='"+r.toUpperCase()+"' action='"+i+"' style='display:none'><\/form>"),f=n(t).serializeArray();return f.forEach(function(t){n("<input type='hidden' />").appendTo(u).prop("name",t.name).val(t.value)}),u}return t},formFromModel:function(t,r,u,f,e){var o,s,h;i.hasValue(e)||(r=r||"POST",u=u||window.location.href,e=n("<form method='"+r.toUpperCase()+"' action='"+u+"' style='display:none'><\/form>"),f="");o=n.type(t);switch(o){case"null":case"undefined":n("<input type='hidden' />").appendTo(e).prop("name",f);break;case"date":n("<input type='hidden' />").appendTo(e).prop("name",f).val(t.toISOString());break;case"array":t.forEach(function(n){i.formFromModel(n,r,u,f,e)});break;case"object":s=Object.getOwnPropertyNames(t);s.forEach(function(n){h=f===""?n:f+"."+n;i.formFromModel(t[n],r,u,h,e)});break;default:n("<input type='hidden' />").appendTo(e).prop("name",f).val(t.toString())}return e},getPathSegments:function(n){return n.match(u.segments)},resolvePathSegment:function(n){return u.indexer.test(n)?parseInt(/\d+/.exec(n)):n},getObjectAtPath:function(n,t,r){for(var e=n,s,o=Array.isArray(t)?t:i.getPathSegments(t),f=0;f<o.length;f++){if(s=i.resolvePathSegment(o[f]),e[s]===undefined&&(e[s]=f<o.length-1&&u.indexer.test(o[f+1])?[]:f===o.length-1&&r?[]:f<o.length-1?{}:null),f===o.length-1&&(u.indexer.test(s)||Array.isArray(e[s])===!1))return e;e=e[s]}return e},setModelProperty:function(t,r,u){var f,e,o,h,s;s=i.getPathSegments(u[0].name);h=u.length>1&&u[0].type==="checkbox";e=i.resolvePathSegment(s[s.length-1]);f=i.getObjectAtPath(r,s,h);e in f?o=n.type(f[e]):Array.isArray(f)&&f.length&&(o=n.type(f[0]));Array.isArray(f)&&h?(f.splice(0,f.length),n(u).serializeArray().forEach(function(n){f.push(i.castValue(n.value,o))})):n(u).serializeArray().forEach(function(n){f[e]=i.castValue(n.value,o)})},buildModelFromElements:function(r){var f={},u={},e=n(r).find("[name]");return e.each(function(){this.name in u||(u[this.name]=n(r).find('[name="'+this.name+'"]'))}),Object.getOwnPropertyNames(u).forEach(function(n){i.setModelProperty(r,f,u[n])}),t.log("buildModelFromElements: model:").log(f),f},setElementsFromModel:function(r,u){var f,e,o=n(r);t.log("setELementsFromModel: model:").log(u);o.find("[name]").each(function(){f=i.getModelValue(u,this.name);e=n.type(f);e==="date"||this.type==="date"?n(this).val(i.standardDateFormat(f)):e==="boolean"&&this.type==="checkbox"?this.checked=f:this.type==="radio"?this.checked=this.value==f:n(this).val(f)})},getModelValue:function(n,t){var r,u=i.getPathSegments(t),f=i.resolvePathSegment(u[u.length-1]);try{return(r=i.getObjectAtPath(n,u),r[f]!==undefined)?r[f]:r}catch(e){console&&console.error&&(console.error("Could not resolve object path: "+t),console.error(e))}},triggerEvent:function(t,i,r){try{n.event.trigger({type:t,source:r||i},i)}catch(u){console&&console.error&&console.error(u)}},hasHash:function(n){return n=n||window.location.href,u.hash.test(n)},standardDateFormat:function(n){if(!i.hasValue(n)||n=="")return n;if(typeof n=="string")return n.substring(0,10);var f=n.getFullYear(),r=n.getMonth()+1,u=n.getDate(),t=[];return t.push(f),t.push("-"),r<10&&t.push("0"),t.push(r),t.push("-"),u<10&&t.push("0"),t.push(u),t.join("")},callOnLoad:function(n){n&&r.onLoad&&r.onLoad.call(n);r.onLoad=null},nonce:jQuery.now(),noCache:function(n){var r=(n.indexOf("?")!=-1?"&_=":"?_=")+i.nonce++,t=n.match(/\?.+(?=#)|\?.+$|.+(?=#)|.+/);return n.replace(t,t+r)},castValue:function(t,r){if(!i.hasValue(t)||t==="")return null;switch(r){case"number":return n.isNumeric(t)?parseFloat(t):t;case"boolean":return t.toLowerCase()==="true";case"null":case"undefined":return/true|false/g.test(t.toLowerCase())?t.toLowerCase()==="true":t;default:return t}}};t.priv=i;t.Request=function(n){this.method=n.method.toLowerCase();this.form=i.resolveForm(n);this.action=i.resolveAction(n);this.model=i.resolveModel(n);this.contentType="application/x-www-form-urlencoded; charset=UTF-8";this.transition=n.transition;this.target=i.resolveTarget(n);this.data=this.getData(n);this.source=n.source;this.cache=n.cache;this.expire=n.expire;this.renew=n.renew;this.beforeRequest=n.beforeRequest||i.noop;this.afterRequest=n.afterRequest||i.noop;this.cancel=!1;this.resolve=null;this.reject=null;this.result=null;this.error=null};t.Request.prototype={getData:function(){var r;t.log("resolveData: method:").log(this.method);switch(this.method){case"get":case"ajax-get":case"ajax-delete":case"jsonp":this.model?r=i.formFromModel(this.model).serialize():this.form&&(r=i.formFromInputs(this.form,this.action,this.method).serialize());break;case"post":r=this.model?i.formFromModel(this.model):this.form?i.formFromInputs(this.form,this.action,this.method):n("<form method='POST' action='"+this.action+"' style='display:none'><\/form>");break;case"ajax-post":case"ajax-put":this.model?(r=JSON.stringify(this.model),this.contentType="application/json"):this.form&&(r=i.formFromInputs(this.form,this.action,this.method).serialize())}return r},ajax:function(i){var r=this,u={url:this.action,type:i.toUpperCase(),data:this.data,contentType:this.contentType};t.log("ajax: options: "+u);n.ajax(u).done(r.done.bind(r)).fail(r.fail.bind(r))},done:function(n){this.result=n;this.resolve&&this.resolve(n);this.afterRequest(this)},fail:function(n){this.error=n;this.reject&&this.reject(n);this.afterRequest(this)},methods:{get:function(){window.location=this.action+(this.data?"?"+this.data:"");this.afterRequest(this)},post:function(){var t=this,n=this.data;n.appendTo("body");n[0].submit();setTimeout(function(){n.remove();t.afterRequest(t)},0)},"ajax-get":function(){n.get(this.action,this.data).done(this.done.bind(this)).fail(this.fail.bind(this))},"ajax-post":function(){this.ajax("post")},"ajax-put":function(){this.ajax("put")},"ajax-delete":function(){this.ajax("delete")},jsonp:function(){var t=this,n=document.createElement("script");n.type="text/javascript";n.src=this.action+(this.data?"?"+this.data:"");document.body.appendChild(n);setTimeout(function(){document.body.removeChild(n);t.afterRequest(t)},10)}},exec:function(){if(this.reset(),!i.hasValue(this.methods[this.method]))throw"Unsupported method: "+this.method;return i.hasValue(this.action)&&this.action!==""&&(this.beforeRequest(this),this.cancel?this.afterRequest(this):this.cache&&(this.result||this.error)?(t.log("request.exec: cached"),this.result&&this.done(this.result),this.error&&this.fail(this.error),this.afterRequest(this)):(this.methods[this.method].bind(this)(),t.log("request.exec: executed"))),this},then:function(n,t){var i=this;return typeof n=="function"&&(this.resolve=n,this.result!==null&&n(i.result)),typeof t=="function"&&(this.reject=t,this.error!==null&&t(i.error)),this},"catch":function(n){return this.then(undefined,n)},reset:function(){this.cache||(this.result=null,this.error=null);this.cancel=!1;this.resolve=null;this.reject=null}};t.Transitions={replace:function(t,i){var u=n(t),r=n(i);return u.replaceWith(r),r},"fade-in":function(t,i){var r=n(t),u=n(i);return r.fadeOut(0).empty().append(u.contents()).fadeIn(),r},"flip-horizontal":function(t,i){var r=n(t),u=n(i),f=r.parent().addClass("flip-horizontal").css("position","relative");return r.addClass("front"),u.addClass("back").width(r.width()).appendTo(f),setTimeout(function(){f.addClass("flip")},100),setTimeout(function(){r.remove();f.removeClass("flip").removeClass("flip-horizontal");u.removeClass("back").css("width","")},1e3),u},"flip-vertical":function(t,i){var r=n(t),u=n(i),f=r.parent().addClass("flip-vertical").css("position","relative");return r.addClass("front"),u.addClass("back").css("width",r.width()).appendTo(f),setTimeout(function(){f.addClass("flip")},100),setTimeout(function(){r.remove();f.removeClass("flip").removeClass("flip-vertical");u.removeClass("back").css("width","")},1e3),u},"slide-left":function(t,i){var r=n(t),u=n(i),f=r.parent().addClass("slide-left").css("position","relative");return r.addClass("left"),u.addClass("right").appendTo(f),setTimeout(function(){f.addClass("slide")},100),setTimeout(function(){r.remove();f.removeClass("slide").removeClass("slide-left");u.removeClass("right")},800),u},append:function(t,i){var u=n(t),r=n(i);return u.append(r),r},prepend:function(t,i){var u=n(t),r=n(i);return u.prepend(r),r}};t.instance=new t.Controller;r=t.instance})(jQuery,lojax);
//# sourceMappingURL=lojax.min.js.map
