var lojax=lojax||{};(function(n){var r,t,i;lojax.on=function(t,r){n(document).on(t,function(){i.executeRequest(r)})};lojax.off=function(t){n(document).off(t)};lojax.get=function(n){i.executeRequest(n)};lojax.in=function(n){i.in=n};lojax.closeModal=function(){t.hasValue(i.modal)&&(n.fn.modal?i.modal.modal("hide"):n.fn.kendoWindow&&i.modal.data("kendoWindow").close())};lojax.events={beforeRequest:"beforeRequest",afterRequest:"afterRequest",beforeUpdateModel:"beforeUpdateModel",afterUpdateModel:"afterUpdateModel",beforeInject:"beforeInject",afterInject:"afterInject",ajaxError:"ajaxError"};lojax.logging=!1;lojax.log=function(n){try{lojax.logging&&console&&console.log&&console.log(n)}catch(t){}return lojax};lojax.Cache=function(){this.store={}};lojax.Cache.prototype={add:function(n){this.remove(n.action);this.store[n.action]=n;n.expire&&this.setTimeout(n)},remove:function(n){var t=this.store[n];t&&(t.timeout&&clearTimeout(t.timeout),delete this.store[n])},get:function(n){var t=this.store[n];if(t)return t.renew==="sliding"&&t.timeout&&this.setTimeout(t),this.store[n]},setTimeout:function(n){var t=this;n.timeout&&clearTimeout(n.timeout);n.timeout=setTimeout(function(){t.expire(n)},n.expire*1e3)},expire:function(n){n.renew==="auto"?(n.exec(),this.setTimeout(n)):this.remove(n.action)},clear:function(){var n=this,t=Object.getOwnPropertyNames(this.store);t.forEach(function(t){n.remove(t)})},contains:function(n){return n in this.store}};lojax.Controller=function(){var i=this;this.div=null;this.modal=null;this.currentTransition=null;this.currentPanel=null;this.cache=new lojax.Cache;n(function(){i.div=n("<div style='display:none'><\/div>").appendTo("body");n(document).on("click","[data-request],[jx-request],[data-method]:not([data-trigger]),[jx-method]:not([jx-trigger])",i.handleRequest);n(document).on("change","[data-method][data-trigger*=change],[jx-method][jx-trigger*=change]",i.handleRequest);n(document).on("keydown","[data-method][data-trigger*=enter],[jx-method][jx-trigger*=enter]",i.handleEnterKey);n(document).on("submit","form[data-method],form[jx-method]",i.handleRequest);n(document).on("change","[data-model],[jx-model]",i.updateModel);window.addEventListener("hashchange",i.handleHash,!1);i.loadDataSrcDivs();i.bindToModels();i.prefetchAsync();t.hasHash()&&setTimeout(i.handleHash,0)})};lojax.Controller.prototype={handleRequest:function(r){var f=t.getConfig(this),o=n(this),u,e;lojax.log("handleRequest: params: ").log(f);u=new lojax.Request(f);t.hasHash(u.action)&&f.method==="ajax-get"?(e=u.getHash(),i.currentTransition=u.transition,"#"+e===window.location.hash?i.handleHash():window.location.hash=e):i.executeRequest(u);r.stopPropagation();r.preventDefault()},handleHash:function(){var u,r=window.location.hash;lojax.log("handleHash: hash:").log(r);t.hasHash()?(u=n('a[name="'+r.substr(1)+'"]'),u.size()===0&&i.executeRequest({action:r,method:"ajax-get",transition:i.currentTransition}),i.currentTransition=null):r===""&&i.executeRequest({action:window.location.href,method:"ajax-get"})},executeRequest:function(n){(n instanceof lojax.Request||(n=new lojax.Request(n)),lojax.log("executeRequest: request: ").log(n),n.action!==null)&&(n.cache?this.cache.contains(n.action)?n=this.cache.get(n.action):(this.cache.add(n),n.exec()):n.exec(),n.then(function(t){i.injectContent(n,t)}).catch(i.handleError))},handleEnterKey:function(n){n.which===13&&i.handleRequest.call(this,n)},bindToModels:function(i){i=i||document;var r,u,f=[],e=n(i).find("[data-model],[jx-model]").add(i).filter("[data-model],[jx-model]");return lojax.log("bindToModels: dataModels:").log(e),e.each(function(){u=n(this);r=t.getModel(u);t.hasValue(r)&&r!==""?t.setElementsFromModel(u,r):r=t.buildModelFromElements(u);u.data("model",r);f.push(r);lojax.log("bindToModels: model:").log(r)}),f},updateModel:function(i){var u=n(this),s=n(i.target),e=t.getModel(u),f=i.target.name,o,r;t.hasValue(f)&&((o=u.find('[name="'+f+'"]'),r={target:i.target,name:f,value:s.val(),type:n.type(e[f]),model:e,cancel:!1},lojax.log("updateModel: o:").log(r),t.triggerEvent(lojax.events.beforeUpdateModel,r,u),r.cancel)||(lojax.log("updateModel: o.model").log(r.model),t.setModelProperty(u,r.model,o),t.triggerEvent(lojax.events.afterUpdateModel,r,u),lojax.log("updateModel: afterUpdateModel raised")))},injectContent:function(r,u){var h,c,l,v,f,e,o=n.parseHTML(u,!0),a,s;if(lojax.log("injectContent: nodes:").log(o),o!==null){for(a=function(){var u=n(this);h=u.attr("jx-panel");c=r.target||n('[jx-panel="'+h+'"]');c.size()>0&&(lojax.log("injectContent: jx-panel: "+h),v=t.resolveTransition(r,u),e=v(c,u),t.hasValue(r)&&(e.refresh=r.exec.bind(r)),t.triggerEvent(lojax.events.afterInject,e,u),i.bindToModels(e),t.callIn(e),i.loadDataSrcDivs(e),i.prefetchAsync(e))},i.in=null,s=0;s<o.length;s++){if(f=n(o[s]),t.triggerEvent(lojax.events.beforeInject,o,f),i.modal===null)if(f.is(".modal")){i.createModal(f);continue}else l=f.find(".modal"),l.length&&i.createModal(l);r.target||f.is("[jx-panel]")?a.call(f):n(o[s]).find("[jx-panel]").each(a)}i.div.empty();o.forEach(function(t){f=n(t);f.is("script,style")&&i.div.append(f)})}},createModal:function(r){if(n.fn.modal){i.modal=n(r).appendTo("body").modal({show:!1,keyboard:!0});i.modal.on("hidden.bs.modal",function(){t.hasValue(i.modal)&&(i.modal.off("hidden.bs.modal",i.onModalClose),i.modal.modal("hide"),n(i.modal).remove(),i.modal=null)});i.modal.modal("show")}else n.fn.kendoWindow&&(i.modal=n(r).appendTo("body").kendoWindow({title:n(r).find(".dialog-header").text(),modal:!0,animation:{open:{effects:"fade:in"}},visible:!1,close:function(){t.hasValue(i.modal)&&(i.modal.data("kendoWindow").destroy(),n(i.modal).remove(),i.modal=null)}}),i.modal.data("kendoWindow").center().open(),i.modal.find("[data-dismiss=modal]").click(function(){i.modal.data("kendoWindow").close()}));i.modal&&(i.bindToModels(i.modal),t.callIn(i.modal),i.loadDataSrcDivs(i.modal),i.prefetchAsync(i.modal))},loadDataSrcDivs:function(r){r=r||document;n(r).find("div[data-src]").each(function(){var r=n(this),u=r.data("src");i.executeRequest({action:t.cacheProof(u),method:"ajax-get",target:r,source:r,transition:r.data("transition")||"append"})})},prefetchAsync:function(i){var u=this,f,r;i=i||document;setTimeout(function(){n(i).find("[data-cache=prefetch],[jx-cache=prefetch]").each(function(){f=t.getConfig(this);r=new lojax.Request(f);r.action&&!u.cache.contains(r.action)&&(u.cache.add(r),r.exec(),lojax.log("prefetchAsync: request:").log(r))})})},handleError:function(n){if(t.triggerEvent(lojax.events.ajaxError,n),!n.handled){var i=[];Object.getOwnPropertyNames(n).forEach(function(t){typeof n[t]!="function"&&i.push(n[t])});lojax.log("handleError: response: ").log(n)}}};r={segments:/'.+'|".+"|[\w\$]+|\[\d+\]/g,indexer:/\[\d+\]/,quoted:/'.+'|".+"/,search:/\?.+(?=#)|\?.+$/,hash:/#(.*)?[a-z]{2}(.*)?/i};t={hasValue:function(n){return n!==undefined&&n!==null},attributes:"method action transition target form model cache expire renew".split(" "),getConfig:function(i){var r,u=n(i);return u.is("[data-request]")?r=JSON.parse(u.data("request").replace(/'/g,'"')):u.is("[jx-request]")?r=JSON.parse(u.attr("jx-request").replace(/'/g,'"')):(r=u.data(),t.attributes.forEach(function(n){var i="jx-"+n,t;n in r||(t=u.attr(i),t!==undefined&&(r[n]=t))})),r.source=i,r},resolveAction:function(i){if(t.hasValue(i.action)&&i.action.length)return i.action;if(t.hasValue(i.source)&&t.hasValue(i.source.href)&&i.source.href.length&&i.source.href.substr(i.source.href.length-1,1)!=="#"&&i.source.href.substr(0,11)!=="javascript:")return i.source.href;if(n(i.source).is("[type=submit]")){var r=n(i.source).closest("form,[data-model],[jx-model]");if(r.is("form"))return r.attr("action")||window.location.href}return n(i.source).is("form")?n(i.source).attr("action")||window.location.href:null},resolveForm:function(i){var r;return t.hasValue(i.form)?n(i.form):n(i.source).is("[type=submit]")&&(r=n(i.source).closest("form,[data-model],[jx-model]"),r.is("form"))?r:n(i.source).is("form")?i.source:null},resolveModel:function(i){lojax.log("resolveModel: params:").log(i);var r;return typeof i.model=="object"?i.model:t.hasValue(i.source)&&t.hasValue(t.getModel(i.source))?t.getModel(i.source):n(i.source).is("[type=submit]")&&(r=n(i.source).closest("form,[data-model],[jx-model]"),r.is("[data-model],[jx-model]"))?t.getModel(r):null},getModel:function(t){var i=n(t).data("model");return i===undefined&&(i=JSON.parse(n(t).attr("jx-model")||"null"),n(t).data("model",i)),i},resolveContentType:function(n){return n.model?"application/json":"application/x-www-form-urlencoded; charset=UTF-8"},resolveData:function(n){var i;switch(n.method){case"get":case"ajax-get":n.model?i=t.formFromModel(n.model).serialize():n.form&&(i=t.getForm().serialize());break;case"post":n.model?i=t.formFromModel(n.model):n.form&&(i=t.getForm());break;case"ajax-post":case"ajax-put":n.model?(i=t.formFromModel(n.model),i=JSON.stringify(i),n.contentType="application/json"):n.form&&(i=t.getForm().serialize());break;case"ajax-delete":case"jsonp":n.form&&(i=t.getForm().serialize())}},resolveTarget:function(i){return t.hasValue(i.target)?n(i.target):null},resolveInputs:function(t){return n(t).find(":input").add(n(t).filter(":input"))},resolveTransition:function(t,i){return t.transition?lojax.Transitions[t.transition]||lojax.Transitions["fade-in"]:lojax.Transitions[n(i).attr("data-transition")]||lojax.Transitions["fade-in"]},buildForm:function(i,r,u){if(n(i).length){u=u||"POST";var f=n("<form method='"+u.toUpperCase()+"' action='"+r+"' style='display:none'><\/form>"),e=t.resolveInputs(i).serializeArray();return e.forEach(function(t){n("<input type='hidden' />").appendTo(f).prop("name",t.name).val(t.value)}),f}return i},formFromModel:function(i,r,u,f,e){var o,s,h;t.hasValue(e)||(r=r||"POST",u=u||window.location.href,e=n("<form method='"+r.toUpperCase()+"' action='"+u+"' style='display:none'><\/form>"),f="");o=n.type(i);switch(o){case"null":case"undefined":n("<input type='hidden' />").appendTo(e).prop("name",f);break;case"date":n("<input type='hidden' />").appendTo(e).prop("name",f).val(i.toISOString());break;case"array":i.forEach(function(n){t.formFromModel(n,r,u,f,e)});break;case"object":s=Object.getOwnPropertyNames(i);s.forEach(function(n){h=f===""?n:f+"."+n;t.formFromModel(i[n],r,u,h,e)});break;default:n("<input type='hidden' />").appendTo(e).prop("name",f).val(i.toString())}return e},getPathSegments:function(n){return n.match(r.segments)},resolvePathSegment:function(n){return r.indexer.test(n)?parseInt(/\d+/.exec(n)):r.quoted.test(n)?n.slice(1,-1):n},getObjectAtPath:function(n,i,u){for(var e=n,s,o=Array.isArray(i)?i:t.getPathSegments(i),f=0;f<o.length;f++){if(s=t.resolvePathSegment(o[f]),e[s]===undefined&&(e[s]=f<o.length-1&&r.indexer.test(o[f+1])?[]:f===o.length-1&&u?[]:f<o.length-1?{}:null),f===o.length-1&&(r.indexer.test(s)||Array.isArray(e[s])===!1))return e;e=e[s]}return e},setModelProperty:function(i,r,u){var f,e,o,h,s;s=t.getPathSegments(u[0].name);h=u.length>1&&u[0].type==="checkbox";e=t.resolvePathSegment(s[s.length-1]);f=t.getObjectAtPath(r,s,h);e in f?o=n.type(f[e]):Array.isArray(f)&&f.length&&(o=n.type(f[0]));Array.isArray(f)&&h?(f.splice(0,f.length),n(u).serializeArray().forEach(function(n){f.push(t.castValue(n.value,o))})):n(u).serializeArray().forEach(function(n){f[e]=t.castValue(n.value,o)})},buildModelFromElements:function(i){var u={},r={},f=n(i).find("[name]");return f.each(function(){this.name in r||(r[this.name]=n(i).find('[name="'+this.name+'"]'))}),Object.getOwnPropertyNames(r).forEach(function(n){t.setModelProperty(i,u,r[n])}),lojax.log("buildModelFromElements: model:").log(u),u},setElementsFromModel:function(i,r){var u,f,e=n(i);typeof r=="string"&&(r=JSON.parse(r));lojax.log("setELementsFromModel: model:").log(r);e.find("[name]").each(function(){u=t.getModelValue(r,this.name);f=n.type(u);f==="date"||this.type==="date"?n(this).val(t.standardDateFormat(u)):f==="boolean"&&this.type==="checkbox"?this.checked=u:this.type==="radio"?this.checked=this.value==u:n(this).val(u)})},getModelValue:function(n,i){var r,u=t.getPathSegments(i),f=t.resolvePathSegment(u[u.length-1]);try{return(r=t.getObjectAtPath(n,u),r[f]!==undefined)?r[f]:r}catch(e){lojax.log("Could not resolve object path: "+i);lojax.log(e)}},triggerEvent:function(t,i,r){try{lojax.log("triggerEvent: name:").log(t);lojax.log("triggerEvent: src:").log(r);n.event.trigger({type:t,source:i},i)}catch(u){console&&console.log&&console.log(u)}},checkHash:function(n){var t=n.indexOf("#");return t!==-1?n.substring(t+1):n},hasHash:function(n){return n=n||window.location.href,r.hash.test(n)},standardDateFormat:function(n){if(!t.hasValue(n)||n=="")return n;if(typeof n=="string")return n.substring(0,10);var f=n.getFullYear(),r=n.getMonth()+1,u=n.getDate(),i=[];return i.push(f),i.push("-"),r<10&&i.push("0"),i.push(r),i.push("-"),u<10&&i.push("0"),i.push(u),i.join("")},callIn:function(n){n&&i.in&&i.in.call(n);i.in=null},nonce:jQuery.now(),cacheProof:function(n){var i=n;return i+=n.indexOf("?")===-1?"?":"&",i+"_="+t.nonce++},castValue:function(i,r){if(!t.hasValue(i)||i==="")return null;switch(r){case"number":return n.isNumeric(i)?parseFloat(i):i;case"boolean":return i.toLowerCase()==="true";case"null":case"undefined":return/true|false/g.test(i.toLowerCase())?i.toLowerCase()==="true":i;default:return i}}};lojax.priv=t;lojax.Request=function(n){this.method=n.method.toLowerCase();this.form=t.resolveForm(n);this.action=t.resolveAction(n);this.model=t.resolveModel(n);this.contentType=t.resolveContentType(n);this.transition=n.transition;this.target=t.resolveTarget(n);this.source=n.source;this.cancel=!1;this.resolve=[];this.reject=[];this.result=null;this.error=null;this.expire=n.expire;this.renew=n.renew};lojax.Request.prototype={getSearch:function(){var r,i="";return t.hasValue(this.form)?(r=t.resolveInputs(this.form),i=t.buildForm(r).serialize()):t.hasValue(this.model)&&(i=n.param(this.model)),i},getForm:function(n){return n=n||"post",t.hasValue(this.form)?t.buildForm(this.form,this.action,n):t.hasValue(this.model)?t.formFromModel(this.model,n,this.action):t.formFromModel(null,n,this.action)},getHash:function(){var i=t.checkHash(this.action),n;return i!==null?(n=this.getSearch(),i+(n!==""?"?"+n:"")):null},ajax:function(t){var r=this,i={url:this.action,type:t.toUpperCase()};/POST|PUT/.test(i.type)&&this.model?(i.data=JSON.stringify(this.model),i.contentType="application/json"):i.data=this.getSearch();lojax.log("ajax: options: "+i);n.ajax(i).done(r.done.bind(r)).fail(r.fail.bind(r))},done:function(n){this.result=n;this.resolve.forEach(function(t){t(n)});t.triggerEvent(lojax.events.afterRequest,this,this.source)},fail:function(n){this.error=n;this.reject.forEach(function(t){t(n)});t.triggerEvent(lojax.events.afterRequest,this,this.source)},methods:{get:function(){var n=this.getSearch(),i=t.checkHash(this.action);window.location=i+"?"+n;t.triggerEvent(lojax.events.afterRequest,this,this.source)},post:function(){var i=this,n=this.getForm(type);n.appendTo("body");n[0].submit();setTimeout(function(){n.remove();t.triggerEvent(lojax.events.afterRequest,i,n)},0)},"ajax-get":function(){var i=t.checkHash(this.action),r=this.getSearch();n.get(i,r).done(this.done.bind(this)).fail(this.fail.bind(this))},"ajax-post":function(){this.ajax("post")},"ajax-put":function(){this.ajax("put")},"ajax-delete":function(){this.ajax("delete")},jsonp:function(){var i=this,r=this.getSearch(),u=t.checkHash(this.action),n=document.createElement("script");n.type="text/javascript";n.src=u+"?"+r;document.body.appendChild(n);setTimeout(function(){document.body.removeChild(n);t.triggerEvent(lojax.events.afterRequest,i,i.source)},10)}},exec:function(){if(this.result=null,this.error=null,this.cancel=!1,!t.hasValue(this.methods[this.method]))throw"Unsupported method: "+this.method;return t.hasValue(this.action)&&this.action!==""&&(t.triggerEvent(lojax.events.beforeRequest,this,this.source),this.cancel?t.triggerEvent(lojax.events.afterRequest,this,this.source):this.methods[this.method].bind(this)()),this},then:function(n,t){var i=this;return typeof n=="function"&&this.resolve.indexOf(n)===-1&&(this.resolve.push(n),this.result!==null&&n(i.result)),typeof t=="function"&&this.reject.indexOf(t===-1)&&(this.reject.push(t),this.error!==null&&t(i.error)),this},"catch":function(n){return this.then(undefined,n)},clear:function(){this.resolve.splice(0,this.resolve.length);this.reject.splice(0,this.reject.length)}};lojax.Transitions={replace:function(t,i){return n(t).replaceWith(i),i},"fade-in":function(t,i){return t.fadeOut(0).empty().append(n(i).contents()).fadeIn(),t},"flip-horizontal":function(t,i){var r=n(t).parent().addClass("flip-horizontal").css("position","relative");return n(t).addClass("front"),n(i).addClass("back").width(t.width()).appendTo(r),setTimeout(function(){r.addClass("flip")},100),setTimeout(function(){n(t).remove();r.removeClass("flip").removeClass("flip-horizontal");n(i).removeClass("back").css("width","")},1e3),i},"flip-vertical":function(t,i){var r=n(t).parent().addClass("flip-vertical").css("position","relative");return t.addClass("front"),n(i).addClass("back").css("width",t.width()).appendTo(r),setTimeout(function(){r.addClass("flip")},100),setTimeout(function(){t.remove();r.removeClass("flip").removeClass("flip-vertical");n(i).removeClass("back").css("width","")},1e3),i},"slide-left":function(t,i){var r=t.parent().addClass("slide-left").css("position","relative");return n(t).addClass("left"),n(i).addClass("right").appendTo(r),setTimeout(function(){r.addClass("slide")},100),setTimeout(function(){t.remove();r.removeClass("slide").removeClass("slide-left");n(i).removeClass("right")},800),i},append:function(t,i){return n(t).append(i),i},prepend:function(t,i){return n(t).prepend(i),i}};lojax.prefix="jx";lojax.instance=new lojax.Controller;i=lojax.instance})(jQuery);